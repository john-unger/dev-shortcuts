#!/usr/bin/env zsh

function print_instructions() {
    local tag_name="$1"
    echo "Run these commands manually:"
    echo "  git tag -a \"$tag_name\" -m \"\""
    echo "  git push origin \"$tag_name\""
}

function git-tag-current() {
    # Enable strict error handling inside the function
    set -euo pipefail

    # Optional argument for the suffix, defaults to "2" if not provided
    local suffix="${1:-2}"
    local tag_name="v$(date +'%Y.%m.%d')"

    echo "Creating tag... Using \"${tag_name}\""

    # Try to create the initial tag
    if ! git tag -a "$tag_name" -m "" 2>/dev/null; then
        echo "Error creating tag '${tag_name}'."
        echo -n "Do you want to append \".${suffix}\"? (y/n): "
        read response
        response=$(echo "$response" | tr '[:upper:]' '[:lower:]')

        if [[ "$response" == "y" || "$response" == "yes" ]]; then
            tag_name="${tag_name}.${suffix}"
            echo "Creating tag with suffix: \"${tag_name}\""
            if ! git tag -a "$tag_name" -m ""; then
                echo "Failed to create '${tag_name}' even after appending \".${suffix}\"."
                print_instructions "$tag_name"
                return 1
            fi
        else
            # User declined to add the suffix
            print_instructions "$tag_name"
            return 1
        fi
    fi

    # If we're here, we have a successfully created tag
    echo "Pushing tag '${tag_name}'..."
    git push origin "$tag_name"
    echo "Tag '${tag_name}' created and pushed successfully."
}
